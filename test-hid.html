<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>なでしこボード接続テスト</title>
</head>

<body>
<!-- ここに画面レイアウトをあらかじめ作っておく -->
<h2>なでしこボード接続テスト 2021/5/3</h2>
<button id="requestDeviceButton">request device</button>
<button id="openButton">open device</button>
<button id="closeButton">close device</button>
<button id="beepButton">beep</button>
<button id="ledButton">LEDオン</button>
<button id="sensor1Button">センサ1測定</button>
<button id="out1Button">出力1</button>
<p>※下に表示されるログは，console.logと同じものです。
ChromeブラウザならCtrl+Shift+Iを押してconsoleを表示 → 上部タブから「Console」を選ぶと，
より詳細な情報が得られます。</p>
<hr />
<div id="div1"></div>

<script type="text/javascript">
let outputReportId = 0;
let device;
var ADval = 0;
var USBconnected = 0;	// 処理可＝1，不可＝０
var outputReport = new Uint8Array(64);
const filters = [
  {
    // なでしこボードのHIDフィルタ
    vendorId: 0x3289,
    productId: 0x2001
  }
];

function print(str) {
	const el = document.getElementById("div1");
	el.innerText = el.innerText + "\n" + str;
	console.log(str);
}

// HID APIを使えるか
if(!("hid" in navigator)) {
    print('HID NG');
} else {
    print('HID OK');
}

navigator.hid.getDevices().then(devices => {
	if (devices.length == 0) {
		// まだ接続されていないとき
		print(`No HID devices selected. Press the "request device" button.`);
		return;
	}

	// すでに接続されているとき
	device = devices[0];
	print(`User previously selected "${device.productName}" HID device.`);
	print(`Now press "open device" button to receive input reports.`);
});

// 接続と切断に対するイベントリスナー登録
navigator.hid.addEventListener('connect', ({device}) => {
	print(`HID connected: ${device.productName}`);
});

navigator.hid.addEventListener('disconnect', ({device}) => {
	print(`HID disconnected: ${device.productName}`);
});

const waitFor = duration => new Promise(r => setTimeout(r, duration));


/*----------------------------------------------------------*/
// 接続状態をUSBconnectedに格納
function ChkHIDItem() {
	if (!device)  {
		USBconnected = -1;			// 未接続
	} else if( device.opened ) {
		USBconnected = 1;			// 接続＆オープン完了
	} else {
		USBconnected = 0;			// 接続したが未オープン
	}
	
}

/*----------------------------------------------------------*/
// 接続ボタンを押した時　デバイスを要求
requestDeviceButton.onclick = async event => {
	try {
		[device] = await navigator.hid.requestDevice({ filters });
		if (!device) return;
		
		// 接続できました
		print(`User selected "${device.productName}" HID device.`);
		print(`Now press "open device" button to receive input reports.`);
	} catch {
		print("error");
	};
};

// デバイスを開く時
openButton.onclick = async event => {
	if (!device) return;

	await device.open();
	device.addEventListener("inputreport", handleInputReport);
	print(`${device.productName} opened: ${device.opened}`);
	print( device );
};

// デバイスを閉じる時
closeButton.onclick = async event => {
	if (!device) return;

	await device.close();
	print(`${device.productName} opened: ${device.opened}`);
};

// ボード側から受信したときのイベント
function handleInputReport(e) {
	const { data, device, reportId } = e;
	
	//print(e.device.productName + ": got input report " + reportId);
	//print(new Uint8Array(data.buffer));
	
	// 測定値
	ADval = data.getUint8(2);
	ADval = (ADval << 8) | data.getUint8(1);
	print( ADval );
}

function getRandomInt(max) {
  return Math.floor(Math.random() * max);
}

// beepボタンを押した時
beepButton.onclick = async event => {
	ChkHIDItem();
	if( USBconnected == 1 ) {
		note = getRandomInt(23);

		// beep
		outputReport[0] = 'P'.charCodeAt(0);
		outputReport[1] = note;
		await device.sendReport(outputReportId, outputReport);
		print(`beep on  note:${note}`);

		await waitFor(500);

		// beep
		outputReport[0] = 'P'.charCodeAt(0);
		outputReport[1] = 23;
		await device.sendReport(outputReportId, outputReport);
		print("beep off");
	}
};

// ledボタンを押した時
ledButton.onclick = async event => {
	ChkHIDItem();
	if( USBconnected == 1 ) {
		// turn on
		outputReport[0] = 'O'.charCodeAt(0);
		outputReport[1] = 0;
		outputReport[2] = 1;
		await device.sendReport(outputReportId, outputReport);
		print("led on");

		await waitFor(1000);

		// turn off
		outputReport[2] = 0;
		await device.sendReport(outputReportId, outputReport);
		print("led off");
	}
};

// センサ１ボタンを押した時
sensor1Button.onclick = async event => {
	ChkHIDItem();
	if( USBconnected == 1 ) {
		// turn on
		outputReport[0] = 'A'.charCodeAt(0);
		await device.sendReport(outputReportId, outputReport);
		print("sensor1");
		await waitFor(100);
		print(`ADval: ${ADval}`);
	}
};

// out1ボタンを押した時
out1Button.onclick = async event => {
	ChkHIDItem();
	if( USBconnected == 1 ) {
		// turn on
		outputReport[0] = 'O'.charCodeAt(0);
		outputReport[1] = 1;
		outputReport[2] = 1;
		await device.sendReport(outputReportId, outputReport);
		print("output1 turn on");

		await waitFor(1000);

		// turn off
		outputReport[2] = 0;
		await device.sendReport(outputReportId, outputReport);
		print("output1 turn off");
	}
};


</script>
</body></html>

