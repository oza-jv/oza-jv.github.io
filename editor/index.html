<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<title>学習用なでしこパッド</title>
</head>

<body>
<!-- なでしこ3のエンジンを取り込み -->
<script type="text/javascript" src="https://nadesi.com/v3/cdn.php?v=3.1.19&f=release/wnako3.js&run"></script>
<!-- プラグインを取り込み -->
<script defer src='https://nadesi.com/v3/cdn.php?v=3.1.19&f=release/plugin_csv.js'></script>
<script defer src='https://nadesi.com/v3/cdn.php?v=3.1.19&f=release/plugin_datetime.js'></script>
<script defer src='https://nadesi.com/v3/cdn.php?v=3.1.19&f=release/plugin_markup.js'></script>
<script defer src='https://nadesi.com/v3/cdn.php?v=3.1.19&f=release/plugin_kansuji.js'></script>
<script defer src='https://nadesi.com/v3/cdn.php?v=3.1.19&f=release/plugin_turtle.js'></script>
<script defer src='https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js'></script>
<script type="text/javascript" src="https://oza-jv.github.io/plugin_media.js"></script>
<script type="text/javascript" src="./plugin_hyouji.js"></script>
<!-- 独自スタイル定義 -->
<style>
.nako3result {
	background-color: #f0fff0; padding:8px;
	fontsize: 16px;
	line-height: 1.4em;
}
.nako3error {
	background-color: #fff0f0; padding:8px; color: #904040;
	font-size:1em; border:1px solid #a0a0ff; margin:4px;
}
.nako3info {
	background-color: #f0f0ff; padding:8px; color: #404090;
	font-size:1em; border:1px solid #a0a0ff; margin:4px;
}
.flexbox {
	display: flex;
}
.main {
	width: 50%;
	padding: 0px 20px
}
.sub {
	width: 50%;
	padding: 0px 20px
}
@media screen and (max-width: 767px) {
	.flexbox {
		display: flex;
	}
	.flexbox .main {
		width: 100%;
		padding: 0px 20px
	}
	.flexbox .sub {
		width: 100%;
		padding: 0px 20px
	}
}

</style>
<div class="flexbox">
	<div class="main">
		<h3>なでしこでプログラムをつくろう！</h3>
		<div>
			プログラムを入力したら、<button onclick="nako3_run()">▶ 実行</button> しよう！
		</div>
		<hr />
		<!-- ace.js editor -->
		<div id="editor" style="height: 480px; border:2px solid black"></div>
		<hr />
		<div>
			<button onclick="nako3_savels(1)">LSに保存</button>
			<button onclick="nako3_loadls()">LSから読込</button>
			<button onclick="nako3_clearls(1)">LSをクリア</button>
		</div>
		<hr />
		<div>
			<input type="file" id="nako3_file" accept=".txt" onChange="nako3_loadfile()"/>
			<button onclick="nako3_loadfile()">←選んだファイルを読み込む</button>
		</div>
		<!-- sample -->
		<hr />
		<div>
			<select id="nako3_sample">
				<option value="">お手本を選ぶ</option>
				<option value="./sample/sample-movie.txt">動画の使い方</option>
				<option value="./sample/sample-kazuate.txt">数当てゲーム</option>
				<option value="./sample/sample-chart1.txt">線グラフ</option>
				<option value="dummy.txt">ダミー</option>
			</select>
			<button onclick="nako3_loadsample()">←選んだお手本を読み込む</button>
		</div>

		<!-- ace.js editor -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
		<script>
			const LSKEY = "nakoedit";
		
			// ace.js init
			var editor = ace.edit("editor");
			editor.setTheme("ace/theme/clouds");
			editor.setFontSize(14);
			editor.getSession().setMode("ace/mode/text");
			editor.getSession().setUseWrapMode(false);
			editor.getSession().setTabSize(2);
			var defs =	"クジラを絵追加。\n" +
						"「こんにちは、クジラです。よろしくね。」と話す。\n";
			editor.setValue(defs , 1);
			
			// nadesiko init
			function nako3_run() {
				if (typeof(navigator.nako3) === 'undefined' || editor === undefined) {
					alert('現在ライブラリを読み込み中です。しばらくお待ちください。')
					return
				}
			const code = editor.getValue()
			var div_name = "#nako3_result"
			var canvas_name = "#nako3_canvas"
			var addon =
				"「" + div_name + "」へDOM親要素設定;" +
				"「" + div_name + "」に「」をHTML設定;" +
				"「" + canvas_name + "」へ描画開始;"
			const preCode = addon
			try {
				nako3_clear(0)
				navigator.nako3.runReset(preCode + code, "main.nako3", preCode)
				console.log("DONE")
			} catch (e) {
				nako3_print("==ERROR==" + e.message + "")
				//editor.editorMarkers.addByError(code, e)
				console.log(e)
			}
		}

		const nako3_print = function (s) {
			console.log("[表示] " + s)
			var info = document.getElementById("nako3_info")
			if (!info) return
			var err = document.getElementById("nako3_error")
			if (!err) return
			s = "" + s // 文字列に変換
			
			// エラーだった場合
			if (s.substr(0, 9) == "==ERROR==") {
				s = s.substr(9)
				err.innerHTML = s
				err.style.display = 'block'
				info.style.display = 'none'
				return
			} else {
				info.innerHTML = to_html(s);
				info.style.display = 'block'
				err.style.display = 'none'
			}
		}

		function to_html(s) {
			s = '' + s
			return s.replace(/\&/g, '&amp;')
					.replace(/\</g, '&lt;')
					.replace(/\>/g, '&gt;')
		}
		
		const nako3_clear = function (s) {
			// 引数0ならエラーとinfoだけ消す。0より大きいときは結果も消す。
			var result = document.getElementById("nako3_result")
			if (!result) return
			result.innerHTML = ''

			var canvas = document.getElementById("nako3_canvas")
			if (!canvas) return
			var ctx = canvas.getContext('2d')
			ctx.clearRect(0, 0, canvas.width, canvas.height)

			if ( s > 0 )	{
				result.style.display = 'none'
				canvas.style.display = 'none'
			} else {
				result.style.display = 'block'
				canvas.style.display = 'block'
			}

			var err = document.getElementById("nako3_error")
			if (!err) return
			err.innerHTML = ''
			err.style.display = 'none'

			var info = document.getElementById("nako3_info")
			if (!info) return
			info.innerHTML = ''
			info.style.display = 'none'
		}
		
		// load and save to local storage
		const nako3_loadls = function () {
			try {
				var s = localStorage.getItem(LSKEY);
				if (!s) {
					nako3_print("ローカルストレージには，何も保存されていません");
				} else {
					const c = confirm("ローカルストレージに保存されているプログラムを読み込んでいいですか？");
					if (c) {
						nako3_clear(1);
						s = "" + s;
						editor.setValue(s, 1);
						nako3_print("ローカルストレージに保存されているプログラムを読み込みました");
					}
				}
			} catch(e) {
				nako3_print(e);
			}
		}

		const nako3_savels = function (flag) {
			try {
				var c = false;
				if (flag > 0) {
					c = confirm("ローカルストレージにプログラムを保存していいですか？");
				} else {
					c = true;
				}
				
				if (c) {
					var s = editor.getValue();
						localStorage.setItem(LSKEY, s);
						nako3_print("ローカルストレージにプログラムを保存しました");
				}
			} catch(e) {
				nako3_print(e);
			}
		}

		const nako3_clearls = function (flag) {
			try {
				var c = false;
				if (flag > 0) {
					c = confirm("ローカルストレージに保存されているプログラムを消去していいですか？");
				} else {
					c = true;
				}
				
				if (c) {
					localStorage.removeItem(LSKEY);
					nako3_print("ローカルストレージに保存されているプログラムを消去しました");
				}
			} catch(e) {
				nako3_print(e);
			}
		}

		// load and save to file
		const nako3_loadfile= function () {
			try {
				// file select
				const f = document.getElementById("nako3_file").files[0];
				if (!f) return;

				const c = confirm( f.name + " を読み込んでいいですか？");
				if (c) {
					//nako3_clear(1);
					const reader = new FileReader();

					reader.addEventListener('load', (event) => {
						editor.setValue( event.target.result, 1 );
						nako3_clear(0);
						nako3_print( f.name + " を読み込みました");
					});
					reader.readAsText(f);
				}
			} catch(e) {
				nako3_print(e);
			}
		}

		const nako3_loadsample= function () {
			try {
				// file select
				const sel = document.getElementById("nako3_sample");
				var f = sel.value;
				if (!f) return;
				var s = sel.options[ sel.selectedIndex ].text;
				
				const c = confirm( s + " を読み込んでいいですか？");
				if (c) {
					fetch( f )
						.then((data) => {
							if (data.ok) {
								return data.text();
							} else {
								return Promise.reject(new Error('読み込み失敗'));
							}
						})
						.then((text) => {
							editor.setValue( text, 1 );
							nako3_clear(1);
							nako3_print( s + " を読み込みました");
						})
						.catch(e => {
							nako3_print(e);
						});
				}
			} catch(e) {
				nako3_print(e);
			}
		}

		</script>
	</div>
	
	<div class="sub">
		<h3>■実行結果</h3>
		<button onclick="nako3_clear(1);">結果を消す</button><hr />
		<!-- ERROR -->
		<div id="nako3_error" class="nako3error" style="display: none"></div>

		<!-- INFO -->
		<div id="nako3_info" class="nako3info" style="display: none"></div>

		<!!-- RESULT -->
		<audio id="audio1"></audio>
		<div id="nako3_result" class="nako3result" style="display: none"></div>
		<canvas id="nako3_canvas" width="640" height="640" display="none"></canvas>
	</div>
</div>
<body></html>


