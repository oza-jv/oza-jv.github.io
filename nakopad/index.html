<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
	<title>学習用なでしこパッド</title>
</head>

<body>
<!-- なでしこ3のエンジンを取り込み -->
<script type="text/javascript" src="https://nadesi.com/v3/cdn.php?v=3.1.20&f=release/wnako3.js&run"></script>
<!-- プラグインを取り込み -->
<script defer src='https://nadesi.com/v3/cdn.php?v=3.1.19&f=release/plugin_csv.js'></script>
<script defer src='https://nadesi.com/v3/cdn.php?v=3.1.19&f=release/plugin_datetime.js'></script>
<script defer src='https://nadesi.com/v3/cdn.php?v=3.1.19&f=release/plugin_markup.js'></script>
<script defer src='https://nadesi.com/v3/cdn.php?v=3.1.19&f=release/plugin_kansuji.js'></script>
<script defer src='https://nadesi.com/v3/cdn.php?v=3.1.19&f=release/plugin_turtle.js'></script>
<script defer src='https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js'></script>
<script type="text/javascript" src="./plugin_media.js"></script>
<script type="text/javascript" src="./plugin_hyouji.js"></script>
<script type="text/javascript" src="./plugin_speak.js"></script>
<!-- 独自スタイル定義 -->
<style>
.nako3result {
	background-color: #f0fff0; padding:8px;
	fontsize: 16px;
	line-height: 1.4em;
}
.nako3error {
	background-color: #fff0f0; padding:8px; color: #904040;
	font-size:1em; border:1px solid #a0a0ff; margin:4px;
}
.nako3info {
	background-color: #f0f0ff; padding:8px; color: #404090;
	font-size:1em; border:1px solid #a0a0ff; margin:4px;
}
.footer {
	font-size:smaller; color:gray;
	margin: 0 20px;
}
button {
	padding: 5px 20px;
	margin: 0 10px;
}
.flexbox {
	display: flex;
	flex-wrap: wrap;
}
.main {
	width: 50%;
	padding: 0px 10px;
	//background-color: #f0f0ff;
}
.sub {
	width: 45%;
	padding: 0px 10px;
	//background-color: #fff0ff;
}
.btnsub {
	width: 95%;
	padding: 0px 10px;
	//background-color: #f0ffff;
}
.btnsub_flex {
	display: flex;
	flex-wrap: wrap;
}
@media screen and (max-width: 830px) {
	.flexbox {
		display: block;
	}
	.flexbox .main {
		width: 95%;
		padding: 0px 20px;
	}
	.flexbox .sub {
		width: 95%;
		padding: 0px 20px;
	}
}
</style>
<div class="flexbox">
	<!-- エディタエリア -->
	<div class="main">
		<h3>なでしこでプログラムをつくろう！</h3>
		<div>
			プログラムを入力したら、<button onclick="nako3_run()">▶ 実行</button> しよう！
		</div>
		<hr />
		<!-- ace.js editor -->
		<div id="editor" style="height: 480px; width:100%; border:2px solid black;"></div>

		<!-- ace.js editor -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
		<script>
			const LSKEY = "nakoedit";	// ローカルストレージの保存キー
		
			// ace.js init
			var editor = ace.edit("editor");
			editor.setTheme("ace/theme/clouds");
			editor.setFontSize(16);
			editor.getSession().setMode("ace/mode/text");
			editor.getSession().setUseWrapMode(false);
			editor.getSession().setTabSize(2);
			editor.setOption("showInvisibles", false)
			
			// nadesiko init
			function nako3_run() {
				if (typeof(navigator.nako3) === 'undefined' || editor === undefined) {
					alert('現在ライブラリを読み込み中です。しばらくお待ちください。')
					return
				}
				const code = editor.getValue()
				var div_name = "#nako3_result"
				var canvas_name = "#nako3_canvas"
				var addon =
					"「" + div_name + "」へDOM親要素設定;" +
					"「" + div_name + "」に「」をHTML設定;" +
					"「" + canvas_name + "」へ描画開始;"
				const preCode = addon
				try {
					nako3_clear(2)
					navigator.nako3.runReset(preCode + code, "main.nako3", preCode)
					scr_to_id( "nako3_result" );
					console.log("DONE")
				} catch (e) {
					nako3_print("==ERROR==" + e.message + "")
					//editor.editorMarkers.addByError(code, e)
					console.log(e)
				}
			}

			const nako3_print = function (s) {
				console.log("[表示] " + s)
				var info = document.getElementById("nako3_info")
				if (!info) return
				var err = document.getElementById("nako3_error")
				if (!err) return
				s = "" + s // 文字列に変換

				var audio = document.querySelector("#audio1");
				
				// エラーだった場合
				if (s.substr(0, 9) == "==ERROR==") {
					s = s.substr(9)
					err.innerHTML = s
					err.style.display = 'block'
					info.style.display = 'none'
					audio.src = './audio/se_maoudamashii_system18.mp3';
					scr_to_id( "nako3_error" );
				} else {
					info.innerHTML = to_html(s);
					info.style.display = 'block'
					err.style.display = 'none'
					audio.src = './audio/se_maoudamashii_system13.mp3';
					scr_to_id( "nako3_info" );
				}

				// エラー音
				audio.currentTime = 0;
				audio.play();
			}

			function to_html(s) {
				s = '' + s
				return s.replace(/\&/g, '&amp;')
						.replace(/\</g, '&lt;')
						.replace(/\>/g, '&gt;')
			}
			
			function scr_to_id( id ) {
				var el = document.getElementById( id );
				if (!el) return;
				var rect = el.getBoundingClientRect();
				
				var elemtop = rect.top + window.pageYOffset;
				if( elemtop < 200 ) elemtop = 0;
				document.documentElement.scrollTop = elemtop;
			}
			
			const nako3_clear = function (s) {
				// 引数0ならエラーとinfoだけ消す。1なら実行結果だけ。2なら全て。
				if ( s > 0 )	{
					var result = document.getElementById("nako3_result")
					if (!result) return
					result.innerHTML = ''

					var canvas = document.getElementById("nako3_canvas")
					if (!canvas) return
					//canvas.style.visibility='hidden';
					var ctx = canvas.getContext('2d')
					ctx.clearRect(0, 0, canvas.width, canvas.height)
					canvas.hidden = true;
				}

				if ( (s == 0) || (s == 2) ) {
					var err = document.getElementById("nako3_error")
					if (!err) return
					err.innerHTML = ''
					err.style.display = 'none'

					var info = document.getElementById("nako3_info")
					if (!info) return
					info.innerHTML = ''
					info.style.display = 'none'
				}
			}
			
			// load and save to local storage
			const nako3_loadls = function () {
				try {
					var s = localStorage.getItem(LSKEY);
					if (!s) {
						nako3_print("==ERROR==ローカルストレージには，何も保存されていません");
					} else {
						const c = confirm("ローカルストレージに保存されているプログラムを読み込んでいいですか？");
						if (c) {
							nako3_clear(1);
							s = "" + s;
							editor.setValue(s, 1);
							nako3_print("ローカルストレージに保存されているプログラムを読み込みました");
						}
					}
				} catch(e) {
					nako3_print(e);
				}
			}

			const nako3_savels = function (flag) {
				try {
					var c = false;
					if (flag > 0) {
						c = confirm("ローカルストレージにプログラムを保存していいですか？");
					} else {
						c = true;
					}
					
					if (c) {
						var s = editor.getValue();
							localStorage.setItem(LSKEY, s);
							nako3_print("ローカルストレージにプログラムを保存しました");
					}
				} catch(e) {
					nako3_print(e);
				}
			}

			const nako3_clearls = function (flag) {
				try {
					var c = false;
					if (flag > 0) {
						c = confirm("ローカルストレージに保存されているプログラムを消去していいですか？");
					} else {
						c = true;
					}
					
					if (c) {
						localStorage.removeItem(LSKEY);
						nako3_print("ローカルストレージに保存されているプログラムを消去しました");
					}
				} catch(e) {
					nako3_print(e);
				}
			}

			// load and save to file
			const nako3_loadfile= function () {
				try {
					// file select
					const f = document.getElementById("nako3_file").files[0];
					if (!f) return;

					const c = confirm( f.name + " を読み込んでいいですか？");
					if (c) {
						//nako3_clear(1);
						const reader = new FileReader();

						reader.addEventListener('load', (event) => {
							editor.setValue( event.target.result, 1 );
							nako3_clear(0);
							nako3_print( f.name + " を読み込みました");
							
							// ファイル名をセット
							var s = baseName( f.name );
							var fn = document.getElementById("nako3_filename");
							fn.value = s;
						});
						reader.readAsText(f);
					}
				} catch(e) {
					nako3_print(e);
				}
			}

			const nako3_loadsample= function () {
				try {
					// file select
					const sel = document.getElementById("nako3_sample");
					var f = sel.value;
					if (!f) return;
					var s = sel.options[ sel.selectedIndex ].text;
					
					const c = confirm( s + " を読み込んでいいですか？");
					if (c) {
						fetch( f )
							.then((data) => {
								if (data.ok) {
									return data.text();
								} else {
									return Promise.reject(new Error('読み込み失敗'));
								}
							})
							.then((text) => {
								editor.setValue( text, 1 );
								nako3_clear(1);
								nako3_print( s + " を読み込みました");
							})
							.catch(e => {
								nako3_print(e);
							});
					}
				} catch(e) {
					nako3_print(e);
				}
			}

			const nako3_loaddefault= function () {
				try {
					var f = "default.txt";
					var defs =	"クジラを絵追加。\n「こんにちは、クジラです。よろしくね。」と声出す。\n";
					fetch( f )
						.then((data) => {
							if (data.ok) {
								return data.text();
							} else {
								return Promise.reject(new Error('読み込み失敗'));
							}
						})
						.then((text) => {
							editor.setValue( text, 1 );
						})
						.catch(e => {
							editor.setValue(defs , 1);
						});
				} catch(e) {
					editor.setValue(defs , 1);
				}
			}

			const nako3_savefile= function () {
				try {
					// テキスト取得
					const txt = editor.getValue();
					if( txt.length < 1 ) {
						nako3_print( "==ERROR==保存するプログラムがありません。");
						return;
					}
					
					const f = document.getElementById("nako3_filename");
					if (!f) return;
					var fn = f.value;
					if ( fn.length < 1 ) {
						nako3_print( "==ERROR==ファイル名を入力してください。");
						return;
					} else {
						fn += ".txt";
					}
					
					// 文字をBlob化
					const blob = new Blob([txt], { type: 'text/plain' });
					
					// ダウンロード用のaタグ生成
					const a = document.getElementById("nako3_save");
					a.href = URL.createObjectURL( blob );
					a.download = fn;
					a.click();
					
					nako3_print( "プログラムを保存しました。保存したファイルは，ダウンロードフォルダにあります。" );
				} catch(e) {
					nako3_print(e);
				}
			}

			const nako3_canvas_on = function () {
				var canvas = document.getElementById( "nako3_canvas" )
				if (!canvas) return
				//canvas.style.visibility='visible';
				canvas.hidden = false;
			}

			const nako3_canvas_off = function () {
				var canvas = document.getElementById( "nako3_canvas" )
				if (!canvas) return
				//canvas.style.visibility='hidden';
				canvas.hidden = true;
			}

			// 独自関数の登録
			var nako3_add_func = function () {
			  navigator.nako3.setFunc("描画オン", [], nako3_canvas_on);
			  navigator.nako3.setFunc("描画オフ", [], nako3_canvas_off);
			}
			var nako3_init_timer = setInterval(function(){
				if (typeof(navigator.nako3) === 'undefined') return
				clearInterval(nako3_init_timer)
				nako3_add_func()
			}, 500);
			
			// ファイル名から拡張子を取り除く
			function baseName(str) {
				var base = new String(str).substring(str.lastIndexOf('/') + 1); 
				if( base.lastIndexOf(".") != -1 )       
					base = base.substring(0, base.lastIndexOf("."));
			   return base;
			}
			
			// 初期
			nako3_loaddefault();
			nako3_clear(2);
			nako3_canvas_off();

		</script>
		<!-- マニュアルへのリンク -->
		<div class="footer">
			<a href="https://nadesi.com/v3/doc/index.php?%E5%91%BD%E4%BB%A4%E4%B8%80%E8%A6%A7%2F%E6%A9%9F%E8%83%BD%E9%A0%86&show" target="_blank" rel="noopener noreferrer">なでしこv3の命令一覧</a>（公式サイトへ）
		</div>
	</div>
	
	<!-- 結果表示エリア -->
	<div class="sub">
		<h3>■実行結果</h3>
		<button onclick="nako3_run()">▶ 実行</button>
		<button onclick="nako3_clear(1);">結果を消す</button><hr />
		<!-- ERROR -->
		<div id="nako3_error" class="nako3error" style="display: none"></div>

		<!-- INFO -->
		<div id="nako3_info" class="nako3info" style="display: none"></div>

		<!!-- RESULT -->
		<audio id="audio1"></audio>
		<canvas id="nako3_canvas" width="400" height="360" hidden></canvas>
		<div id="nako3_result" class="nako3result" display="none"></div>
	</div>
</div>

<!-- 機能ボタンエリア -->
<div class="btnsub">
	<hr />
	<div class="btnsub_flex">
		<select id="nako3_sample">
			<option value="">■お手本を選ぶ</option>
			<option value="./sample/sample-omikuji-1.txt">おみくじ１　もし～ならば</option>
			<option value="./sample/sample-omikuji-2.txt">おみくじ２　もし～ならば～違えば</option>
			<option value="./sample/sample-omikuji-3.txt">おみくじ３　もし～ならば～違えばもし</option>
			<option value="">---</option>
			<option value="./sample/sample-kazuate-1.txt">数当てゲーム１　乱数と分岐</option>
			<option value="./sample/sample-kazuate-2.txt">数当てゲーム２　反復</option>
			<option value="./sample/sample-kazuate-3.txt">数当てゲーム３　ヒントを加える</option>
			<option value="./sample/sample-kazuate-4.txt">数当てゲーム４　フラグ変数を使う</option>
			<option value="./sample/sample-kazuate.txt">数当てゲーム 豪華版</option>
			<option value="">---</option>
			<option value="./sample/sample-click10sec.txt">マウスクリック練習　１０秒ゲーム</option>
			<option value="">---</option>
			<option value="./sample/sample-media-1pic.txt">画像の扱い方</option>
			<option value="./sample/sample-media-2audio.txt">音の扱い方</option>
			<option value="./sample/sample-media-3movie.txt">動画の扱い方</option>
			<option value="./sample/sample-media-4chart1.txt">線グラフ</option>
		</select>
		<button onclick="nako3_loadsample()">お手本読込</button>
	</div>
	<hr />
	<div>プログラムを一時保存…</div>
	<div class="btnsub_flex">
		<button onclick="nako3_savels(1)">LSに一時保存</button>
		<button onclick="nako3_loadls()">LSから読込</button>
		<button onclick="nako3_clearls(1)">LSをクリア</button>
	</div>
	<hr />
	<div style="display:block">
		<div>ファイルから読込…<input type="file" id="nako3_file" accept=".txt" onChange="nako3_loadfile()"/></div>
		<div>ファイルに保存…<input type="text" id="nako3_filename" placeholder="ファイル名" size="20"/>.txt
		<button onclick="nako3_savefile()">保存</button><a id="nako3_save" href=""></a></div>
	</div>
	<hr />
</div>

<!-- footer -->
<div class="footer">
	<div>学習用なでしこパッド v1.10  (2021/3/15)</div>
	<div>※<a href="https://nadesi.com/" target="_blank" rel="noopener noreferrer">日本語プログラミング言語「なでしこ」 v3.1.19</a> を利用しています。</div>
	<div>※音素材は，<a href="" title="フリー音楽素材/魔王魂" target="_blank" rel="noopener noreferrer">フリー音楽素材/魔王魂</a>のものを使用しています。</div>
	<div>※画像素材は，なでしこv1に同梱のもの を使用しています。</div>
</div>
<body></html>
